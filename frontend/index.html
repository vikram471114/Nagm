<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø¥Ø¶Ø§ÙØ© Ø®Ø· Inter Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù€ Tailwind */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© */
        }
        /* ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-out;
        }
        .stat-card h2 {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .stat-card ul {
            margin-top: 0.5rem;
            list-style: none;
            padding-left: 0;
        }
        .stat-card li {
            font-size: 1.125rem; /* 18px */
            font-weight: 700;
            color: #1d4ed8; /* text-blue-700 */
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e5e7eb; /* text-gray-200 */
        }
        .stat-card li:last-child {
            border-bottom: none;
        }
        .stat-card li .points {
            font-weight: 500;
            color: #374151; /* text-gray-700 */
            font-size: 1rem; /* 16px */
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© */
        .digital-card {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .digital-card .value {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
        }
        .digital-card .title {
            font-size: 1rem; /* 16px */
            color: #dbeafe; /* text-blue-100 */
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader.hidden { display: none; }
        #error-message.hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
            <p id="period-label" class="text-lg text-gray-600">ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø±Ø¶: Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        </header>

        <!-- (Ø¬Ø¯ÙŠØ¯) Ù‚Ø³Ù… ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-8 flex flex-wrap items-center gap-4">
            <span class="font-semibold">ØªØµÙÙŠØ© Ø­Ø³Ø¨:</span>
            <button id="week-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            <button id="today-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</button>
            
            <div class="flex items-center gap-2">
                <input type="date" id="start-date" class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <span class="text-gray-500">Ø¥Ù„Ù‰</span>
                <input type="date" id="end-date" class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <button id="filter-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">ØªØ·Ø¨ÙŠÙ‚</button>
            </div>
        </div>

        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loader" class="text-center py-10">
            <div class="inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-2 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</p>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£!</strong>
            <span id="error-text" class="block sm:inline">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</span>
        </div>

        <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div id="stats-container" class="hidden">
            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø±Ù‚Ù…ÙŠØ© (Ø«Ø§Ø¨ØªØ©) -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-8">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="activeUsersToday" class="stat-card digital-card"></div>
                <div id="activeUsersWeek" class="stat-card digital-card"></div>
                <div id="averagePointsToday" class="stat-card digital-card"></div>
            </div>

            <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙØªØ±Ø© (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ) -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-8">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="starsOfPeriod" class="stat-card"></div>
                <div id="bigMatchHuntersByPoints" class="stat-card"></div>
                <div id="bigMatchHuntersByCount" class="stat-card"></div>
                <div id="highScorers" class="stat-card"></div>
                <div id="longestStreak" class="stat-card"></div>
                <div id="mostConsistent" class="stat-card"></div>
            </div>

            <!-- (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø«: Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-8">Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ (Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div id="league-Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" class="stat-card"></div>
                <div id="league-Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ" class="stat-card"></div>
                <div id="league-Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Ø£ÙˆØ±ÙˆØ¨Ø§" class="stat-card"></div>
                <div id="league-Ø¯ÙˆØ±ÙŠ Ø±ÙˆØ´Ù† Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ" class="stat-card"></div>
                <div id="league-Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ" class="stat-card"></div>
                <div id="league-Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ" class="stat-card"></div>
                <div id="league-Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ" class="stat-card"></div>
            </div>
        </div>
    </div>

    <script>
        // =======================
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // =======================
        const API_BASE_URL = 'https://nagm.onrender.com/api/v1/stats';
        const LOADER = document.getElementById('loader');
        const ERROR_MSG = document.getElementById('error-message');
        const ERROR_TEXT = document.getElementById('error-text');
        const STATS_CONTAINER = document.getElementById('stats-container');
        const PERIOD_LABEL = document.getElementById('period-label');

        // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªØ·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø§ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…)
        const LEAGUE_NAMES = [
            "Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ", "Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ", "Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Ø£ÙˆØ±ÙˆØ¨Ø§", "Ø¯ÙˆØ±ÙŠ Ø±ÙˆØ´Ù† Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ",
            "Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ", "Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ", "Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ"
        ];

        // =======================
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        // =======================

        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø®Ø·Ø£
        const showLoader = () => {
            LOADER.classList.remove('hidden');
            STATS_CONTAINER.classList.add('hidden');
            ERROR_MSG.classList.add('hidden');
        };

        const hideLoader = () => LOADER.classList.add('hidden');

        const showError = (message) => {
            hideLoader();
            ERROR_TEXT.textContent = message;
            ERROR_MSG.classList.remove('hidden');
        };

        // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ø§Ù„ØªÙŠ ØªÙ‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø§Ø¯Ù„)
        function renderStatList(elementId, title, items, unit) {
            const card = document.getElementById(elementId);
            if (!card) return;

            let itemsHtml = '<ul>';
            items.forEach(item => {
                const value = item.points ?? item.correct ?? item.count ?? item.total;
                itemsHtml += `
                    <li>
                        <span>${item.name}</span>
                        <span class="points">${value} ${unit}</span>
                    </li>
                `;
            });
            itemsHtml += '</ul>';

            card.innerHTML = `<h2>${title}</h2> ${itemsHtml}`;
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        function renderDigitalCard(elementId, title, value, icon) {
            const card = document.getElementById(elementId);
            if (!card) return;
            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="title">${title}</span>
                    <span class="text-3xl">${icon}</span>
                </div>
                <div class="value mt-2">${value}</div>
            `;
        }

        // =======================
        // Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // =======================
        async function fetchStats(queryString = '') {
            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}${queryString}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                renderData(result.data);
                hideLoader();
                STATS_CONTAINER.classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching stats:', error);
                showError(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`);
            }
        }

        function renderData(stats) {
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØªØ±Ø©
            PERIOD_LABEL.textContent = `ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø±Ø¶: ${stats.period}`;

            // 1. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©
            renderDigitalCard('activeUsersToday', 'Ù…Ø´ØªØ±Ùƒ Ù†Ø´Ø· Ø§Ù„ÙŠÙˆÙ…', stats.activeUsersToday, 'ğŸ‘¥');
            renderDigitalCard('activeUsersWeek', 'Ù…Ø´ØªØ±Ùƒ Ù†Ø´Ø· Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', stats.activeUsersWeek, 'ğŸ—“ï¸');
            renderDigitalCard('averagePointsToday', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ', stats.averagePointsToday, 'ğŸ“Š');

            // 2. Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø© (ØªØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø§Ø¯Ù„)
            renderStatList('starsOfPeriod', 'Ù†Ø¬Ù… Ø§Ù„ÙØªØ±Ø©', stats.starsOfPeriod, 'Ù†Ù‚Ø·Ø©');
            renderStatList('bigMatchHuntersByPoints', 'Ù‚Ù†Ø§Øµ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ (Ù†Ù‚Ø§Ø·)', stats.bigMatchHuntersByPoints, 'Ù†Ù‚Ø·Ø©');
            renderStatList('bigMatchHuntersByCount', 'Ù‚Ù†Ø§Øµ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ (Ø¹Ø¯Ø¯)', stats.bigMatchHuntersByCount, 'Ù…Ø¨Ø§Ø±Ø§Ø©');
            renderStatList('highScorers', 'Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ù…Ù† Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø©', stats.highScorers, 'Ù†Ù‚Ø·Ø©');
            renderStatList('longestStreak', 'Ù…Ù„Ùƒ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ (ØªÙˆÙ‚Ø¹ ØµØ­ÙŠØ­)', stats.longestStreak, 'ØªÙˆÙ‚Ø¹');
            renderStatList('mostConsistent', 'Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ)', stats.mostConsistent, 'ØªÙˆÙ‚Ø¹');

            // 3. Ø¹Ø±Ø¶ Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰
            LEAGUE_NAMES.forEach(leagueName => {
                const elementId = `league-${leagueName}`;
                const winners = stats.leagueStars[leagueName] || [{ name: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', points: 0 }];
                renderStatList(elementId, leagueName, winners, 'Ù†Ù‚Ø·Ø©');
            });
        }

        // =======================
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        // =======================
        document.addEventListener('DOMContentLoaded', () => {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            fetchStats('');

            // Ø²Ø± "Ø§Ù„ÙŠÙˆÙ…"
            document.getElementById('today-btn').addEventListener('click', () => {
                fetchStats('?period=today');
            });

            // Ø²Ø± "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"
            document.getElementById('week-btn').addEventListener('click', () => {
                fetchStats(''); // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            });

            // Ø²Ø± "ØªØ·Ø¨ÙŠÙ‚" Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØµØµØ©
            document.getElementById('filter-btn').addEventListener('click', () => {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                if (startDate && endDate) {
                    fetchStats(`?startDate=${startDate}&endDate=${endDate}`);
                } else {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ©.');
                }
            });
        });
    </script>
</body>
</html>
