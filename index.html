<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }
        .stat-card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; display: flex; flex-direction: column; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª */
        .pagination-btn { background: white; border: 1px solid #cbd5e1; color: #334155; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: 0.2s; }
        .pagination-btn:hover:not(:disabled) { background: #f1f5f9; border-color: #94a3b8; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        details summary { list-style: none; cursor: pointer; outline: none; }
        details summary::-webkit-details-marker { display: none; }
        .winners-box { background-color: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 10px; margin-top: 5px; border-radius: 8px; font-size: 0.9rem; max-height: 150px; overflow-y: auto; }
        
        /* Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader-dots div { animation: loader 0.6s infinite alternate; }
        @keyframes loader { to { opacity: 0.3; transform: scale(0.5); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="glass-header">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg">ğŸ“ˆ</div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                    <p class="text-sm text-slate-500">Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª</p>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-2 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                <span class="text-sm font-bold text-slate-600 px-2">Ø§Ù„ÙÙ„ØªØ±Ø©:</span>
                <input type="date" id="start-date" class="border bg-slate-50 rounded-md text-sm px-2 py-1.5 focus:ring-2 focus:ring-blue-500">
                <span class="text-slate-400 text-sm">Ø¥Ù„Ù‰</span>
                <input type="date" id="end-date" class="border bg-slate-50 rounded-md text-sm px-2 py-1.5 focus:ring-2 focus:ring-blue-500">
                <button onclick="applyDateFilter()" class="bg-slate-800 text-white px-4 py-1.5 rounded-md hover:bg-slate-700 transition font-bold text-sm">ØªØ·Ø¨ÙŠÙ‚</button>
                <button onclick="resetFilters()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-300 transition text-sm">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-sm text-slate-500 font-bold">Ù†Ø´Ø· Ø§Ù„ÙŠÙˆÙ…</p>
                    <h3 id="activeUsersToday" class="text-2xl font-bold text-blue-600">--</h3>
                </div>
                <div class="text-3xl">ğŸ‘¥</div>
            </div>
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-sm text-slate-500 font-bold">Ù†Ø´Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹</p>
                    <h3 id="activeUsersWeek" class="text-2xl font-bold text-purple-600">--</h3>
                </div>
                <div class="text-3xl">ğŸ“…</div>
            </div>
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                <div>
                    <p class="text-sm text-slate-500 font-bold">Ù†Ø¬Ù… Ø§Ù„ÙØªØ±Ø©</p>
                    <h3 id="topStarName" class="text-xl font-bold text-emerald-600 truncate max-w-[150px]">--</h3>
                </div>
                <div class="text-3xl">â­</div>
            </div>
        </div>

        <section>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-1 h-6 bg-blue-600 rounded-full"></span>
                    Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
                </h2>
                <div class="text-sm text-slate-500">
                    ØµÙØ­Ø© <span id="current-page" class="font-bold text-slate-800">1</span> Ù…Ù† <span id="total-pages">--</span>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-600 border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4 font-bold w-1/6">Ø§Ù„Ø¨Ø·ÙˆÙ„Ø©</th>
                                <th class="px-6 py-4 font-bold w-1/4">Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</th>
                                <th class="px-6 py-4 font-bold w-1/6">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="px-6 py-4 font-bold w-1/6 text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th class="px-6 py-4 font-bold w-1/4">Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ†</th>
                            </tr>
                        </thead>
                        <tbody id="matches-table-body" class="divide-y divide-slate-100">
                            <tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-between items-center">
                    <button id="prev-btn" onclick="changePage(-1)" disabled class="pagination-btn">â† Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <span class="text-sm text-slate-500" id="total-results">-- Ù†ØªÙŠØ¬Ø©</span>
                    <button id="next-btn" onclick="changePage(1)" disabled class="pagination-btn">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        const BASE_URL = 'https://nagm.onrender.com/api/v1/stats';
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentState = {
            page: 1,
            limit: 50,
            startDate: '',
            endDate: ''
        };

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
        async function fetchGeneralStats() {
            try {
                const res = await fetch(`${BASE_URL}`);
                const json = await res.json();
                const d = json.data;
                document.getElementById('activeUsersToday').textContent = d.activeUsersToday;
                document.getElementById('activeUsersWeek').textContent = d.activeUsersWeek;
                if(d.starsOfPeriod && d.starsOfPeriod.length > 0) {
                    document.getElementById('topStarName').textContent = d.starsOfPeriod[0].name;
                }
            } catch (err) { console.error(err); }
        }

        // 2. Ø¬Ù„Ø¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (Ù…Ø¹ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„ÙÙ„ØªØ±Ø©)
        async function fetchMatches() {
            const tbody = document.getElementById('matches-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center"><div class="loader-dots inline-flex gap-1"><div class="w-2 h-2 bg-blue-500 rounded-full"></div><div class="w-2 h-2 bg-blue-500 rounded-full" style="animation-delay:0.2s"></div><div class="w-2 h-2 bg-blue-500 rounded-full" style="animation-delay:0.4s"></div></div> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

            try {
                // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·
                let url = `${BASE_URL}/matches?page=${currentState.page}&limit=${currentState.limit}`;
                if (currentState.startDate && currentState.endDate) {
                    url += `&startDate=${currentState.startDate}&endDate=${currentState.endDate}`;
                }

                const res = await fetch(url);
                const json = await res.json();

                tbody.innerHTML = ''; 

                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';
                    updatePagination(0, 0, 0);
                    return;
                }

                // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                json.data.forEach(m => {
                    const isPlayed = m.resultFormatted.trim() !== "-";
                    const dateObj = new Date(m.time);
                    const dateStr = dateObj.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
                    const timeStr = dateObj.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

                    // Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ†
                    let winnersHtml = '<span class="text-slate-400 text-xs">--</span>';
                    if (isPlayed) {
                        if (m.winnersCount > 0) {
                            winnersHtml = `
                                <details class="group relative">
                                    <summary class="text-green-600 font-bold hover:underline flex items-center gap-1">
                                        ğŸ‰ ${m.winnersCount} ÙØ§Ø¦Ø²
                                    </summary>
                                    <div class="winners-box absolute z-10 w-48 shadow-lg">
                                        ${m.winnersList.join(' ØŒ ')}
                                    </div>
                                </details>
                            `;
                        } else {
                            winnersHtml = '<span class="text-red-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø²</span>';
                        }
                    }

                    const row = `
                        <tr class="match-row hover:bg-slate-50 transition">
                            <td class="px-6 py-4 text-xs font-bold text-slate-500">${m.league}</td>
                            <td class="px-6 py-4 font-semibold text-slate-700">
                                ${m.teamA} <span class="text-slate-400 mx-1 text-xs">vs</span> ${m.teamB}
                            </td>
                            <td class="px-6 py-4 text-xs text-slate-500">
                                <div class="font-bold">${dateStr}</div>
                                <div class="opacity-70">${timeStr}</div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="${isPlayed ? 'bg-slate-800 text-yellow-400' : 'bg-slate-100 text-slate-400'} px-3 py-1 rounded font-mono font-bold tracking-widest text-sm">
                                    ${m.resultFormatted}
                                </span>
                            </td>
                            <td class="px-6 py-4">${winnersHtml}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
                updatePagination(json.currentPage, json.totalPages, json.total);

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-600">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}</td></tr>`;
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        function updatePagination(current, total, totalCount) {
            document.getElementById('current-page').textContent = current;
            document.getElementById('total-pages').textContent = total;
            document.getElementById('total-results').textContent = `${totalCount} Ù†ØªÙŠØ¬Ø©`;
            
            document.getElementById('prev-btn').disabled = current <= 1;
            document.getElementById('next-btn').disabled = current >= total;
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
        function changePage(delta) {
            currentState.page += delta;
            fetchMatches();
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
        function applyDateFilter() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            if (start && end) {
                currentState.startDate = start;
                currentState.endDate = end;
                currentState.page = 1; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø«
                fetchMatches();
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
        function resetFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            currentState.startDate = '';
            currentState.endDate = '';
            currentState.page = 1;
            fetchMatches();
        }

        // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        document.addEventListener('DOMContentLoaded', () => {
            fetchGeneralStats();
            fetchMatches();
        });

    </script>
</body>
</html>
